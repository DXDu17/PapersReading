# The Devil is in the Details: Delving into Unbiased Data Processing for Human Pose Estimation

------

原文链接：[点这里](https://arxiv.org/abs/1911.07524)

## 目录

- [1. 摘要](#1)
- [2. 介绍](#2)
- [3. 相关工作](#3)
- [4. 人体姿态估计无偏数据处理](#4)
  - [4.1 无偏坐标系变换](#4.1)
    - [4.1.1 连续空间中的数据统一定义](#4.1.1)
    - [4.1.2 坐标系变换概念](#4.1.2)
    - [4.1.3 无偏目标](#4.1.3)
    - [4.1.4 初等运算中的无偏坐标系变换](#4.1.4)
    - [4.1.5 通用坐标系变换](#4.1.5)
    - [4.1.6 有偏坐标系变换的判断](#4.1.6)
  - [4.2 无偏关键点格式转换](#4.2)
    - [4.2.1 无偏关键点格式转换概念](#4.2.1)
    - [4.2.2 无偏关键点格式转换](#4.2.2)
    - [4.2.3 有偏关键点格式转换分析](#4.2.3)
    - [4.2.4 有偏坐标系变换与有偏关键点格式转换的连接分析](#4.2.4)
- [5. 实验](#5)
  - [5.1 在COCO数据集上的结果](#5.1)
    - [5.1.1 实现细节](#5.1.1)
    - [5.1.2 自顶向下范式在验证集上的结果](#5.1.2)
    - [5.1.3 自底向上范式在验证集上的结果](#5.1.3)
    - [5.1.4 在test-dev集上的结果](#5.1.4)
  - [5.2 在CrowdPose数据集上的结果](#5.2)
  - [5.3 自顶向下范式消融实验](#5.3)
  - [5.4 自底向上范式消融实验](#5.4)
- [6. 结论](#6)

<a name="1"></a>

## 1. 摘要

数据处理是训练和推理的基础组成部分，但在人体姿态估计领域却没有被系统地考虑到。本文专注于这一问题，发现人体姿态估计难点在于有偏数据处理。具体地，通过研究SOTA方法中的标准数据处理，其中主要包括坐标系变换和关键点格式转换(如编码换和解码)，本文发现通用翻转策略获得的结果与原始推理结果不一致。此外，一些关键点格式转换方法存在统计误差。这两个问题组合在一起，大大降低了人体姿态估计的性能。这些问题没有得到合理关注，但影响却很严重。为了从源头解决这一困境，本文提出无偏数据处理(UDP)，其由两个技术方面组成，分别用于上述两个问题(即无偏坐标系变换和无偏关键点格式转换)。基于UDP，本文深入了解现有偏差数据处理pipeline，并对其成因、影响及补救措施进行深入研究。此外，作为一种模型不可知方法和一种优越的解决方案，UDP成功的突破了人体姿态估计性能边界。在COCO test-dev数据集上，UDP将自顶向下方法HRNet-W32-256×192提高了1.7AP，将自底向上方法HRNet-W32-512×512提高了2.7AP(加速6.1倍)。HRNet-W48-384×288+UDP达到了76.5 AP，成为人体姿态估计新的SOTA方法。

<a name="2"></a>

## 2. 介绍

2D人体姿态估计在计算机视觉文献中得到了广泛的研究，并服务于许多复杂的下游视觉理解任务，如3D人体姿态估计、人体定相、医疗保健、视频监控和动作识别。本文将数据处理视为一个基本组件。所有视觉识别任务都会用到相似的数据处理方法，如数据增强和不同坐标系之间的变换。与分类、目标检测和语义分割等任务相比，人体姿态估计算法性能在评估原则上对数据处理中使用的方法更加敏感。在人体姿态估计评估中，指标是由gt标注与预测结果之间的位置偏移计算出来的，数据处理引起的小波动将会极大影响姿态估计器的性能。

尽管数据处理很重要，但在人体姿态估计领域却没有被系统地考虑到。就这一问题，本文发现大多数人体姿态估计SOTA系统中广泛使用的数据处理pipeline都存在缺陷。主要由两个常见问题：i) 当采用翻转测试策略时，翻转图像和源图像的结果不一致。偏差源于在resize操作中执行坐标系变换时使用像素测量图像尺寸。ii) 有缺陷的关键点格式转换方法(即编码和解码)会进一步导致精度下降。两个问题逐渐降低了人体姿态估计器的性能。许多方法尝试了改进但并未给出明确报告，如在后处理中直接进行补偿，这对性能产生了巨大影响。其他改进方法有做说明，如在HigherNet中使用更高的网络输出分辨率，则有巨大的延迟成本。

本文提出一种无偏数据处理(UDP)系统，为解决上述两个问题提供一种思路。与其对应，UDP包含两个技术方面：无偏坐标系变换和无偏关键点格式转换。针对无偏坐标系变换，首先提出在连续空间中定义和分析该问题的原则。在此基础上定义坐标系变换概念，并介绍该子问题中的无偏目标。随后对不同基本操作(如剪裁，resize、旋转和翻转)的坐标系变换进行形式化设计，最终构成训练和测试过程中常用的坐标系变换方法。通过数学推理，本文验证了所提坐标系变换pipeline的无偏性，进而深入了解现有有偏坐标系变换pipeline，并对其成因、影响和一些补救措施进行深入研究。类似的，提出无偏关键点格式转换的概念，介绍两种无偏关键点格式转换方法，并深入分析一种典型的有偏示例。通过UDP，可以消除上述问题，实现更高、更可靠的baseline。

为了展示所提方法的有效性，本文在COCO关键点检测基准上进行了综合实验。作为一种模型不可知方法和一种优越的解决方案，UDP成功的突破了人体姿态估计问题的性能边界，如Fig1所示。UDP提高了自顶向下范式的性能，没有额外的延迟。例如在ResNet50-256×192和ResNet152-256×192配置中，UDP分别将SimpleBaseline提升1.5AP(70.2到71.7)和1.0AP(71.9到72.9)。在HRNet-W32-256×192和HRNet-W48-256×192配置中，UDP分别获得1.7AP(73.5到75.2)和1.4AP(74.3到75.7)的增益。HRNet-W48-384×288+UDP达到76.5 AP (1.0AP改进)，并成为自顶向下人体姿态估计新的SOTA方法。此外，在自底向上范式中，UDP在baseline上同时提供了准确性改进和减少延迟。在HigherNet的HRNet-W32-512×512配置中，UDP将其性能提升了2.7AP，同时实现6.1倍加速。在HigherNet-W32-512×512配置中，性能提升+0.8AP，速度提高2.6倍。本文也在CrowdPose上进行了实验，来验证UDP在不同数据分布中的泛化性能。实验结果表明，UDP在该数据集上的性能与在COCO数据集上的一致。最后为了验证方法论分析中的表述，本文通过详尽的消融实验来衡量UDP中每个元素的贡献，以及相关工作中现有补救措施的效果。

文本以文31为基础，从几个方面详尽展开。首先有条理的重排序方法论章节，并用更具体的背景介绍和更详细的数学推理对其进行解释。其次，将UDP应用于自底向上范式方法中，扩展了UDP的覆盖范围，并对SOTA方法HigherNet有了重大发现和推广。第三，本文使用额外数据CrowdPose来验证UDP的泛化性能。在COCO和LVIS 2020比赛中，UDP作为获胜者UDP++的baseline，标志着这项工作成为了人体姿态估计的重要里程碑。

<a name="3"></a>

## 3. 相关工作

人体姿态估计从单人到多人有重大进展，多人姿态估计通常分为自底向上和自顶向下两种方法。

**自底向上方法**    首先检测输入图像中所有人员无关身份的关节，然后将这些关节分组给具体实例。此范式兼顾代价和效率，无关身份的关节检测和分组策略是其关注重点。OpenPose构建了一个包含两个分支的模型，用于预测关键点heatmap和它们之间的成对关系(部分关联场)，后者是分组过程的重点。MultiSenet同时实现了人体检测和姿态估计，提出PRN，根据每个人的边界框对关键点进行分组。为了解决密集场景的人体姿态估计问题，文30设计了一个新的模型，将关节候选单人姿态估计与全局最大化关节关联相结合。同时收集了一个新的数据集CrowdPose，专门用于密集场景的性能评估。文49将一个网络用于heatmap预测和嵌入研究。利用关联嵌入分组，关联嵌入为每个关键点分配一个tag，并根据tag向量之间的L2距离分组关键点。之后，文26将文49中的沙漏网络替换为HigherHRNet。通过使用更高的输出分辨率，HigherNet大大提高了预测精度。

**自顶向下方法**    通过两个阶段实现多人姿态估计，通过人体检测器(如Faster R-CNN)获取人体边界框，预测这些框内的关键点位置。由于单人姿态估计是在固定比例图像块上进行的，因此在多人流行基准COCO上，大多数SOTA性能都是通过自顶向下方法实现的。此范式的现有工作更关注网络结构设计。文56提出使用GAN训练结构感知卷积网络，用于人体姿态结构探索。继ShuffleNet和SENet之后，文59提出Channel Shuffle Module (CSM)和Spatial, Channel-wise Attention Residual Bottleneck (SCARB)。CPN和MSPN是COCO关键点挑战的主要方法，采用级联网络细化关键点预测。SimpleBasline添加了一些反卷积层，来扩大输出特征的分辨率。虽然简单，但是在现存工作中很有竞争力。HRNet在整个过程中保持高分辨率表示，在公共数据集上实现SOTA性能。Mask R-CNN构建了一个端到端的框架，在性能和推理速度之间实现了良好的平衡。

**数据处理**    人体姿态估计数据处理主要包括坐标系变换和关键点格式转换。坐标系变换是指在进行剪裁、resize、旋转和翻转等操作时，在不同坐标系之间变换数据(即关键点坐标和图像矩阵)。在此过程中，大多数SOTA方法在执行resize操作时使用像素来测量图像尺寸，导致在推理中使用翻转策略时结果不一致。这种偏差大大降低了准确度。一些方法提出了慈幼补救措施，但这些措施都是经验性的，没有给出明确的报告。例如在没有任何解释的情况下，SimpleBaseline、HRNet和Darkpose根据经验将翻转图像的结果在网络输出坐标系中移动1个像素，来抑制预测误差。CPN和MSPN通过在网络输入坐标系中将平均结果移动2个像素来实现类似的效果。HigherRnet提出使用更高的网络输出分辨率，并在baseline上进行了实现，采用一些未报告的补偿，获得巨大的优势。这些补救措施既有效又有吸引力，但可能会难以复现且不能直接做比较。本文提出无偏坐标变换来彻底解决这个问题，不仅会提高现有方法的性能，会为将来的工作提供更可靠的baseline。关键点格式转换(即编码和解码)通常表示关节坐标和heatmap之间的转换，由文38首次提出，并在SOTA方法中广泛使用。在训练过程中，标注过的关键点坐标被编码为高斯分布heatmap。测试过程中，网络预测heatmap被解码为关键点坐标。与直接预测关键点坐标相比，该pipeline显示出优越的性能，但由于设计缺陷和固有精度下降原因，仍然不完善。文47中基于分类和回归组合格式的编码-解码范式提供了一个数学上无误的方式，以进一步提高预测精度。类似地，Darkpose提出一种分布感知解码方法来匹配文26使用的编码方法，实现无偏关键点格式转换。本文将介绍两种无偏关机按点转换范式，验证它们的无偏性，并展示其在baseline上的优势。

<a name="4"></a>

## 4. 人体姿态估计无偏数据处理

在人体姿态估计中，数据处理包括不同坐标系之间的变换和不同关键点格式之间的转换。本文将分别从这两个方面（即无偏坐标系变换和无偏关键点格式转换）详细介绍所提无偏数据处理方法。

<a name="4.1"></a>

### 4.1 无偏坐标系变换

由于这是一个新的模糊的话题，为了表述清晰合理，无偏坐标系变换的概念要从基础上构建。本文首先提出连续空间中的数据统一定义。在此定义基础上，介绍了坐标系变换的概念和无偏目标。针对人体姿态估计涉及的问题(即源图像坐标系，网络输入坐标系和网络输入坐标系)，在构建坐标系之间的通用组合变换之前，本文在一些基本操作(如剪裁，resize，旋转和翻转)中设计了坐标系变换。随后，通过数学推理验证本文设计的坐标系变换pipeline的无偏性。最后，为了展示有缺陷的坐标系如何影响研究，本文分析了一些有偏数据处理方法，并深入研究一些SOTA方法使用的有说明和未说明的技术背后的理论。

<a name="4.1.1"></a>

#### 4.1.1 连续空间中的数据统一定义

图像矩阵和目标关键点坐标是人体姿态估计问题中涉及的主要数据。图像以离散格式存储和处理，但关键点坐标是在连续空间中定义、处理和评估的。为了避免坐标系变换pipeline精度下降，在坐标系变换问题中，需要一个统一的范式来统一分析和处理不同的数据。

为此，本文假设存在一个连续图像平面，每个图像矩阵视为从其上离散采样所得，图像矩阵的每个像素是一个特定的采样点。形式上，根据COCO数据集中目标关键点坐标的定义，本文定义坐标系O-XY，如Fig.2所示，来描述连续图像平面。坐标系的原点位于左上角像素处，O-X方向是从左到右，O-Y方向是从上到下。此外，相邻像素间的距离相等，并将其定义为坐标系的单位长度。现有一个从图像平面I采样得到的图像矩阵，I表示为{I(p) = (r, g, b) | p = (x, y), x ∈ {0, 1, 2…w}, y ∈ {0, 1, 2…h}}。w和h是以单位长度计算的图像的宽度和高度。在同一图像平面中还定义了一组目标关键点，表示为{k = (x，y)}。

值得注意的是，这里定义的采样点的大小是无限小的，并且图像语义上有意义区域的大小是用单位长度计算的。因此下面讨论的图像大小(即w表示宽度，h表示高度)不同于图像矩阵的分辨率，后者在常识中广泛用于定义图像大小。在形式上，它们之间的关系如下：



wp和hp分别是以像素统计的图像矩阵的宽度和高度。使用上标p来区分以像素为单位的变量和以单位长度为单位的变量。

<a name="4.1.2"></a>

#### 4.1.2 坐标系变换概念

人体姿态估计中坐标系变换一般可以表述为从源坐标系到目标坐标系的数据描述变换。如Fig3所示，用下标s将源坐标系标记为O(s)-X(s)Y(s)，目标坐标系为O(d)-X(d)Y(d)。关键点坐标的变换可以表示为：



T(s->d)是源坐标系到目标坐标系的坐标系变换矩阵。图像矩阵变换可以表示为：



(T(s->d))(-1)是T(s->d)的逆矩阵。等式3表示，通过将位置p(d)与位置(T(s->d))(-1)(p(d))设置成相同的颜色，使图像常量在语义上与目标坐标系中带标注的关键点对齐。(T(s->d))(-1)(p(d))回溯结果通常不是整数，因此(I(s))(T(s->d))(-1)(p(d))应使用周围有效的点(如Fig.3中的紫色点)通过双线性插值计算。由于只有图像平面的采样结果(即图像矩阵)，插值是减少图像变换中精度下降的最佳方法，但是这并不能彻底解决精度下降的问题。由于插值的精度下降是不可逆转且逐步积累的，所以可以遵循一种原则，即数据处理pipeline中的插值越少，坐标系变换pipeline就越好。

<a name="4.1.3"></a>

#### 4.1.3 无偏目标

无偏是坐标系变换设计中的一个目标，它包括两个方面：一是变换后保持语义对齐。语义对齐意思是不同数据(即图像和关键点)之间的相对位置保持不变(如目标空间中标注的鼻子位置仍精确的位于目标空间描述的图像中的鼻子上)。当等式2和等式3中的变换矩阵相同时可以实现。

另一个方面是在假设网络具有良好学习能力的前提下，使预测结果与gt对齐。换句话说，本文希望网络的学习能力是精度下降的唯一原因，并且坐标变换pipeline没有设计缺陷，不会导致精度下降。下面，本文将详细介绍无偏坐标系变换pipeline，并证明其无偏性质。

<a name="4.1.4"></a>

#### 4.1.4 初等运算中的无偏坐标系变换

人体姿态估计中的坐标系变换源于一些基本操作，如剪裁、resize、旋转和翻转。

**剪裁**    如Fig.4所示，是根据源坐标系ROI = (bxs, bys, bws, bhs)中定义的特定感兴趣区域(ROI)进行的，其中(bxs, bys)表示其中心位置，(bws, bhs)表示其宽度和高度。将源坐标系的原点移动到ROI左上角，可以获得目标坐标系。因此，变换矩阵应设计为：



**Resizing**    如Fig.5所示，只会改变采样策略，并保持图像语义常量与源图像的相同。本文让四角采样点与源图像的四角采样点语义对齐，并让其他采样点均匀分布在四角分割的区域中，唯一改变的是坐标系的单位长度，变换矩阵应设计为：



**旋转**    如Fig.6所示，根据旋转中心进行，旋转中心始终为特定ROI的中心，不是坐标系的原点。该设计旨在保持ROI的中心位置不变(即(bxs, bys) = (bxd, byd))。例如，ROI指的是自顶向下范式中人体实例的边界框，以及自底向上范式中的整个图像。因此，变换矩阵应设计为三种基本变换的集合：



**翻转**    如Fig.7所示，通常以x=ws/2为镜子，水平交换图像的内容。因此，变换矩阵应设计为：



<a name="4.1.5"></a>

#### 4.1.5 通用坐标系变换

在Fig.8所示的人体姿态估计中，设计三个坐标系：源图像坐标系Os-XsYs，下标s对应于大小为(ws, hs)的源图像，网络输入坐标系Oi-XiYi，下标i对应于大小为(wi, hi)的网络输入，网络输出坐标系Oo-XoYo，下标o对应于大小为(wo, ho)的网络输出。

训练过程中，根据特定的ROI(bxs, bys, bws, bhs)和旋转角度θ首先将数据从源图像坐标系变换为网络输入坐标系。一些基本操作顺序如下：



然后获得了一个组合变换：



等式9不仅集成剪裁和resizing等必要的变换，还集成了可选增强操作(即Tf用于随机翻转，Tr用于随机旋转，Tc用于半身和随机剪裁)用于人体姿态估计器训练。剪裁和resizing是必要的，而翻转和旋转是可选的。将网络输入空间中的图像矩阵设置为网络输入，我们在网络输出空间中得到推断结果：



其中N表示网络。通过简单的resizing操作，标注信息在训练的同时从网络输入空间变换到网络的输出空间：



ko在网络输出空间中作为监督信息：



网络在训练过程中得到优化，因此有：



这意味着网络不仅学习图像矩阵Ii到关键点位置ki的映射，还学习变换(Ti→o)的映射在等式11中的定义。

在测试过程中，仅将图像矩阵从源图像坐标系变换到网络输入坐标系，并进行必要的初等变换，这个过程应与训练过程的变换一致：



然后，通过逆变换将等式10中的网络输出变换回源图像坐标系：



以等式13为假设，考虑等式11，14，15，得到以下恒等关系：



这一推论证明，源图像空间的结果与gt完全相等，这意味着上述设计的数据变换pipeline是无偏的，不会涉及系统误差。

在测试过程使用整体翻转时，通过在网络输入空间中执行翻转变换来获得翻转图像：



然后得到网络预测ko，随后在网络输出空间中翻转回来：



以等式13为假设，考虑等式11，17，18，得到一下恒等关系：



这一推论证明，在网络输出空间中，翻转图像的结果与源图像的结果是一致的。结合等式16，源图像空间中翻转图像的结果也与gt一致，不会i涉及系统误差，等式16和19保证了坐标系变换pipeline的无偏性。在下一小节中，它们将用作检查有偏坐标系变换pipeline的指南。

<a name="4.1.6"></a>

#### 4.1.6 有偏坐标系变换的判断

在大多数SOTA方法中，坐标系变换pipeline的有偏问题源于在执行resizing变换时使用以使用分辨率(wsp, hsp)，而不是(ws, hs)。因此，将等式16和19改为：



其中s=wip/wop是用于描述网络输入特征尺寸变化的步长因子。这里k̂s仍然等于ks，表明上述修改不会改变坐标系变换pipeline的无偏特性，并且不会影响预测结果的精度。然而，测试过程采用整体翻转时，k̂'o与k̂o并不完全对齐，在Oo-Xo方向上有(1-s)/s的偏移量。以k̂o为参考，(1-s)/s是网络输出结果k̂o的预测误差。如果直接取k̂'o和k̂o的平均，就像在大多数现有工作中所做的那样：



Oo-Xo方向上的最终误差为：



其中k̂o被视为gt，因为因被等式20证明时无偏的。这种预测误差的量级很大，导致性能大幅下降。在SOTA方法中，针对这一误差有一些经验性补救措施，可分为两类：直接补偿或使用更高的分辨率。

由于误差|(1-s)/2s|有一个由步长因子决定的固定尺寸，直接补偿是有效的，是目前大多数SOTA自顶向下方法的补救措施。例如SimpleBaseline、HRNet和DarkPose在执行平均操作之前，按经验将翻转图像的结果在Oo-Xo方向上偏移一个像素：



用这种方法，最终误差可以降为：



当s > 2时，e(x)'o < e(x)o，当步长因子为4时，这在现有的大多数自顶向下方法中是有用的。直观上，作为推理的结果，在网络输出空间对e(x)'o进行额外的补偿，可以使现有研究的结果更加准确。本文将在消融实验中验证这一点。

另外，利用等式15将e(x)'o映射回源图像坐标系(Os-XsYs)时，有：



其中bws在推理过程中固定。等式26表示较高的网络输入分辨率有助于抑制e(x)'s引起的预测误差。换句话说，现有自顶向下方法得益于更高的输入分辨率，低分辨率会有更多的精度损失。

当不需要在网络输出空间中偏移一个像素时，得到：



这意味着更高的输入分辨率和更高的输出分辨率都可以帮助抑制这一误差。这种方法使得HigherHRnet的性能得到极大提升，通过使用更高的输出分辨率来追求更高的精度，代价是网络推理和后处理有巨大延时。相比之下，无偏数据处理提供了一种方法，使得低分辨率输出能够实现类似的性能提升。除了使用更高的输出分辨率外，HigherHRNet使用另一种未明确报告的操作来调整网络输出，使其分辨率与网络输入相同。该操作也恰好补偿了有偏坐标系变换pipeline造成的误差，以后处理延时为代价提高了HigherHRNet结构的性能。通过消融实验，发现当坐标系变换pipeline是无偏时，该操作是锦上添花，因为会涉及额外误差，在resizing操作中执行一个额外的差值运算会改变网络的输出分布。

<a name="4.2"></a>

### 4.2 无偏关键点格式转换

<a name="4.2.1"></a>

#### 4.2.1 无偏关键点格式转换概念

卷积网络研究在关键点坐标格式上面不占优势，出现了一种更直观、更合适的heastmap格式，并迅速得到验证。关键点格式转换是指关键点与heatmap之间的变换，广泛应用于SOTA方法中。一般来说，编码表示坐标格式到heatmap格式的转换，解码表示逆转换。

关键点格式转换设计的无偏目标是为了避免编码和解码转换中的精度退化。作为既定目标，应该有：



<a name="4.2.2"></a>

#### 4.2.2 无偏关键点格式转换

本小节将介绍两种无偏关键点格式转换范式，同时展示它们的无偏性。

**分类和和回归相结合**的灵感来自于目标检测使用anchor预测包围框，并在文47中首次提出。本文在这里做了详细的介绍和一些修改。训练过程中对每个标注的关键点k = (m, n)进行编码：



其中C为分类heatmap，作用类似于目标检测中的anchor，初步定位关键点。R是一个超参数，指的是被归为正区域的半径。由偏移向量组成，X和Y为回归heatmap，保留了残差定位信息，loss设计为：



其中Loss(reg)中的C定义了感兴趣区域，这意味着只需要学习分类标签为真的区域的偏移量。训练过程中对网络进行了优化，得到了理想的结果，有：



测试过程中，对预测解码：



其中最高响应位置k̂h首先被定位，随后利用预测的偏移量进行更新。将等式30和32考虑在内，有：



这意味着关键点格式转换pipeline不存在系统误差，实现了等式29中的无偏目标。

**分类格式**在大多数SOTA方法中被广泛使用，其中分类heatmap仅用于类高斯分布：



loss设计为：



网络在训练过程中优化，因此有：



测试过程中，引入解码方法DARK，该方法通过搜索一阶导数等于0的高斯分布中心，将分类heatmap解码为关键点坐标：



其中Cˆ'和Cˆ''为Cˆ的一阶导数和二阶导数(即Hessian)。根据文29，泰勒级数近似引起的精度退化可以忽略，k̂理论上接近k，这符合无偏目标。

<a name="4.2.3"></a>

#### 4.2.3 有偏关键点格式转换分析

本文以SimpleBaseline、HRNet和HigherHRNet中使用的关键点格式转换方法为例，研究有偏数据格式转换的影响。关键点编码为高斯分布型分类heatmap(如等式35)，采用次优方法进行解码：



根据等式35的编码，有：



以O−X方向坐标预测为例，其分布为：



假设k在图像平面内均匀分布(即m−Floor(m)和n−Floor(n)在区间[0,1)内都是均匀分布)，则每个方向上的期望误差为E(|m−m̂|) = E(|n−n̂|) = 1/8 = 0.125单位长度，方差为V(|m−m̂|)= V(|n−n̂|)= 1/192≈0.0052。

当用等式15将E(|m−m̂|)映射回源图像坐标系(Os-XsYs)时，有：



考虑到差E(|m−m̂|)和E(|n−n̂|)，采用有偏数据形式转换方法有利于提高网络输出分辨率。这也是HigherHRnet性能提升的一部分原因。

<a name="4.2.4"></a>

#### 4.2.4 有偏坐标系变换与有偏关键点格式转换的连接分析

等式25中的误差对解码结果分布有影响。在特定步长因子s = 4的情况下，考虑到等式21，有：



因此，Oo-XoYo中翻转图像预测的heatmap变为C(X, Y, m + 0.25, n)，平均heatmap分布变为：



用近似来简化下面的分析。最后误差导致等式39中的结果分布发生变化：



Oo-Xo方向的期望误差仅增大1/32个单位长度，有E(|m−m̂|) = 5 / 32 ≈ 0.156，V(|m−m̂|) = 37 / 3072 ≈ 0.012。

考虑到等式23的误差，则式39的解码结果分布变为：



 Oo-Xo方向的期望误差扩大了1/4单位长度，有E(|m−m̂|) = 3/8 = 0.375，V(|m−m̂|) = 1 / 48 ≈ 0.0208。与误差e(x) = (s − 1) / 2s = 0.375相比，有偏解码方法产生的方差将对最终性能产生额外的负面影响。注意，实际误差比上面分析的要复杂，因为等式44的近似也会影响误差。

<a name="5"></a>

## 5. 实验

<a name="5.1"></a>

### 5.1 在COCO数据集上的结果

<a name="5.1.1"></a>

#### 5.1.1 实现细节

对于自顶向下范式，本文以SimpleBaseline和HRNet为基线，并使用官方实现。除本文提出的数据处理pipeline外，所有训练设置都被保留。在此范式中，默认使用分类和回归组合形式的无偏关键点格式转换，等式30中使用超参数取r = 0.0625∗wpo。分类格式在消融实验中得到验证，等式35中的超参数取δ = 2.0。在推理过程中，使用HTC检测器检测人体实例。经多尺度测试，COCO验证集上80类和人体的AP分别为52.9和65.1。利用该人体检测方法，使HRNet和SimpleBaseline在COCO验证集上的结果得到复现，以便进行公平比较。在验证集上测试推理速度，并测量PPS(Person Per Second)。硬件环境主要包括单个RTX 2080ti GPU和Intel(R) Xeon(R) E5-2630-v4@2.20GHz处理器。

对于自底向上范式，本文以HigherHRNet为基线，同时利用HRNet和HigherHRNet的网络结构。除本文提出的数据处理pipeline外，所有训练设置都被保留。在推理过程中，去掉调整网络输出尺寸的操作，使用等式38中的无偏解码方法。分别报告单尺度和多尺度测试(即[x2, x1, x0.5]，其中x2表示输入分辨率放大了2倍，如512x512到1024x1024)。推断速度以IPS(Image Per Second)来衡量。

<a name="5.1.2"></a>

#### 5.1.2 自顶向下范式在验证集上的结果

如Tab1所示，本文报告了将UDP应用于SimpleBaseline和HRNet时性能有所提高。考虑到SimpleBaseline系列，在ResNet-50上的提升为+1.6AP(71.3到72.9)，在ResNet-152上的提升为+1.4 AP(72.9到74.3)。对于更高的网络输入分辨率，分别提升+0.8AP和+0.9AP。对于HRNet系列，在HRNet-w32上的提升为+1.2AP(75.6到76.8)，在HRNet-w48上的提升为+1.3AP(75.9到77.2)。对于更高的网络输入分辨率，分别提升+1.1AP和+0.7AP。本文总结了一些关键特征：i) 不同backbone类型之间的改进是一致的，说明网络的学习能力对有偏数据处理pipeline造成的精度损失影响不大。这表明仅靠提高网络结构的性能无助于解决有偏问题，UDP是必要的解决方案。ii) 较小的网络输入分辨率方法比较大的提升更多。这与方法论分析的网络输入规模越大，误差越低；规模越小，精度下降越快的结论是一致的。iii) 所提方法没有额外的延迟，这意味着UDP提供的上述改进不需要任何成本。

<a name="5.1.3"></a>

#### 5.1.3 自底向上范式在验证集上的结果

本文以HigherHRNet为代表基线，采用HRNet和HigherHRNet两种网络结构。根据26报告的有偏数据处理，HRNet-W32-512x512配置的AP仅为64.4，推理速度为0.8IPS；HigherHRNet-W32-512x512配置的AP为67.1，推理速度为1.1IPS。与UDP相比，HRNet-W32-512x512配置的AP为67.0，推理速度为4.9IPS，有2.6AP优势，比基线快6.1倍。这种配置的性能甚至接近于HigherHRNet-W32-512x512配置的基线，仍然比它快4.5倍。HigherHRNet-W32-512x512-udp配置的AP为67.8，推理速度为2.9IPS，有0.7AP优势，比基线配置快2.6倍。在没有代价的情况下，UDP提升了性能，减少了延迟。使用了UDP，在COCOC al集上，HRNet-W32-512x512和HigherHRNet-W32-512x512的性能差异更合理，AP提高了+0.8，但推理增加了+70%的延迟。

<a name="5.1.4"></a>

#### 5.1.4 在test-dev集上的结果

Tab2和Fig1报告了UDP在COCO test-dev集上的性能。结果表明UDP的泛化性能稳定，与验证集相比有相似的改进。具体来说，本文方法在ResNet50-256x192和ResNet152-256x192配置中分别将SimpleBaseline提高了1.5AP(从70.2到71.7)和1.0AP(从71.9到72.9)。对于W32-256x192和W48-256x192配置的HRNet，UDP的增益分别为1.7AP(从73.5到75.2)和1.4AP(从74.3到75.7)。配备UDP的HRNet-W48-384x288达到76.5AP，创造了人体姿态估计的SOTA技术。

<a name="5.2"></a>

### 5.2 在CrowdPose数据集上的结果

本文利用CrowdPose数据集验证UDP在不同数据分布下的泛化能力。以HigherHRNet为基线，实验配置与COCO数据集相同。根据文26，模型在训练集和验证集上进行训练，在测试集上进行测试。在Tab3中报告了AP改进结果。实验结果表明，UDP不仅提高了所有配置的准确性，而且大大加快了推理速度。这与COCO数据集是一致的。例外的是，当应用UDP时，具有更高输出分辨率的HigherHRNet-W32-512x512配置(AP为65.6，推理速度为2.4IPS)和HigherHRNet-W48-640x640配置(AP为66.7，推理速度为1.8IPS)并没有显示出任何优势，HRNet-W32配置(AP为66.1，推理速度为4.5IPS)和HRNet-W48-640 × 640配置(AP为67.2，推理速度为4.2IPS)。这对HigherHRNet中提出的技术推广提出疑问。因此本文从经验上认为，有偏数据处理pipeline通过影响性能和误导研究人员，对技术发展产生负面影响。

<a name="5.3"></a>

### 5.3 自顶向下范式消融实验

在本小节中，本文使用HRNet-W32骨干网络和256x192输入尺寸对数据处理pipeline涉及的技术进行消融实验。这里的研究包括无偏坐标系变换(UCST)、翻转测试(FT)、在一些SOTA方法中使用的网络输出平一个像素(SNOOP)、第3.1.6节中提出的用于因使用SNOOP留下的残差误差的额外补偿(EC)、分类和回归组合形式的无偏关键点格式转换(UKFT-CCRF)、分类形式的无偏关键点格式转换(UKFT-CF)。Tab4列出了COCO验证集的实验配置和相应的性能。

在没有FT的情况下，配置A和配置B具有相似的性能(AP分别为74.5和74.4)，可以通过等式16和20的建立得到保证。这验证了一个猜想，在执行resizing转换时使用以像素计算的分辨率而不是以单位长度测量的大小对数据处理pipeline的无偏性没有影响的。而当采用FT时，配置C的性能并没有比A有任何改善，甚至从74.5AP下降到73.3AP，下降了1.2AP。这说明等式23中的误差有巨大负面影响。有偏坐标系变换pipeline造成的陷阱很深，对补救措施的需求很大。与UCST相比，配置D(75.7AP)比配置B(74.4AP)提高1.3AP。UCST是利用FT提高性能的前提。

通过经验补偿，配置E+SNOOP的AP为75.6，接近配置D+UCST的结果。这意味着，以无偏配置D为参考，误差的66.7%对性能有主要影响，并被SNOOP抑制掉。其余的对性能的影响很小(即0.1AP左右，75.6到75.7)。随后在配置F中执行EC来验证这一点。实验结果表明，EC仅提高0.2AP(75.6到75.8)，与上述推断一致。

本文经验性的认为评估系统之所以不敏感是因为EC无效，手工标注人体姿态存在一定的偏差。EC证明，残差误差的存在表明广泛使用的没有明确报告的补偿(SNOOP)是一种次优补救，它的可解释性低，准确性也较差。

在配置E和I中，分别用UKFT-CCRF和UKFT-CF替换配置D中的编解码方法。在UKFT中，配置E(76.8AP)和I(76.8AP)与基线配置D(75.7AP)相比有类似的改进(+1.1AP)，这表明有偏关键点格式转换对性能有相当大的影响。也说明本小节使用的配置(输入尺寸为256x192，训练设置为文25的HRNet-W32网络结构)在本文介绍的两种无偏格式上具有相似的学习能力。在配置G中，没有UCST，只使用UKFT- CCRF，性能下降2.3AP(下降到74.5AP)。UCST和UKFT对于准确预测都很重要，数据处理pipeline的缺陷会对结果产生累积影响。

<a name="5.4"></a>

### 5.4 自底向上范式消融实验

本节研究了更高网络输出分辨率(HNOR)、无偏坐标系变换(UCST)、分类形式无偏关键点格式转换(UKFT-CF)和调整网络输出大小(RNO)如何影响自底向上方法HightHRNet。默认使用翻转测试(FT)。Tab5列出了在COCO验证集上的实验配置和相应性能。

对于配置B，首先删除RNO操作，并在基线配置A (64.4AP, 0.8IPS)上应用UCST。性能提高1.5AP至65.9AP，推理速度提高5.9倍至4.9IPS。通过在配置B中额外应用UKFT-CF，配置C的AP为67.0，推理速度相同。UCST和UKFT在自顶向下范式中都是有效的。

配置F(67.1AP, 1.1IPS)为HigherHRNet的推荐配置。通过构造配置E，将RNO从E中移除，以检验该操作的效果。根据结果，RNO提供了0.2 AP的改进，但推理速度有2.6倍的延迟。对于配置H和I，所提UCST和UKFT-CF将配置E的性能提高0.4AP至67.3AP，额外提高0.5AP到67.8AP，推理速度维持在2.9IPS。与配置B和C相比，这些提升相对较小。这符合HNOR有助于抑制隐藏在数据处理pipeline中的部分系统误差的理论。当应用无偏数据处理时，HigherHRNet-W32骨干网络(即配置I)仍然比HRNet-W32(即配置C)有0.8AP的优势，但代价是推理延迟额外增加70%。

最后，通过配置D和J，测试了使用UDP后调整RNO对结果的影响。性能差异分别为0AP(延迟6.1倍)和-0.9AP(延迟2.6倍)。当应用无偏数据处理时，RNO对于自底向上范式不是必要的。配置D性能下降是由resizing操作引起分布变化引起的。因为这破坏了使用UKFT-CF的前提条件，这里严格要求为高斯分布。

<a name="6"></a>

## 6. 结论

本文定量分析了人体姿态估计中常用的有偏数据处理方法。有趣的是，本文发现标准坐标系变换和关键点格式转换的系统误差耦合在了一起，显著降低了自顶向下和自底向上的人体姿态估计器的性能。这为研究界埋下了一个陷阱，随后催生了许多次优补救措施。本文提出一种原则性的无偏数据处理(UDP)策略，由无偏坐标系变换和无偏关键点格式转换组成。UDP不仅推动了人体姿态估计的性能边界，而且通过消除有缺陷的数据处理pipeline形成的陷阱，为研究界提供了可靠的基线。
